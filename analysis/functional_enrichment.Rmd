---
title: "Functional Enrichment"
author: "Jo√£o Vitor F Cavalcante"
date: "`r Sys.setlocale('LC_TIME', 'C'); format(Sys.time(), '%d %B, %Y')`"
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../reports/") })
output:
  html_document:
    code_folding: hide
    self_contained: true
    toc: true
    toc_float: true
    toc_collapsed: false
    theme:
      bslib: true
      bootswatch: minty
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

# Functional Enrichment

## Methodology

- We'll select all significant genes found in the meta-analysis and run
a functional enrichment with the **clusterProfiler** R package.
  - Enrichments were performed against the Gene Ontology database
  and against the KEGG pathway database

## Analysis

```{r}
library(clusterProfiler)
library(org.Hs.eg.db)
library(enrichplot)
library(biomaRt)
library(dplyr)
library(readr)
library(here)

metanalysis <- read_csv(here("data/meta-analise.csv")) %>%
  janitor::clean_names() %>%
  filter(significativo == 1)

# Translate HGNC symbols to Entrez NCBI IDs
translate_genes <- function(genes) {
  ensembl <-
    useEnsembl(biomart = "genes", dataset = "hsapiens_gene_ensembl")

  getBM(
    attributes = c('entrezgene_id',
                   'hgnc_symbol'),
    filters = 'hgnc_symbol',
    values = genes,
    mart = ensembl
  )
}
```

### Gene Ontology

```{r go-enrich, cache=TRUE}
genes_symbol <- metanalysis$gene

enrich_go <- enrichGO(
  gene = genes_symbol,
  OrgDb = "org.Hs.eg.db",
  keyType = "SYMBOL",
  ont = "BP", # Only use Biological Process terms
  qvalueCutoff = 0.05,
  pAdjustMethod = "BH",
  pvalueCutoff = 0.01
)

enrich_terms <- enrich_go@result[enrich_go@result$p.adjust < 0.01, ]

write_csv(enrich_terms, here("results/metanalysis_go_enrichment.csv"))
```

In the figure below, "Count" refers to the total number of genes from the input set
that enriched for that particular term.

```{r go-plot-1}
barplot(enrich_go,
        drop = TRUE,
        showCategory = 10,
        title = "GO Biological Processes")

ggplot2::ggsave(here("results/go_barplot.pdf"))
```

In the figure below, GeneRatio refers to the ratio of genes that enriched
to a particular term against the total number of genes that enriched for any term.
"Count" refers to the total number of genes that enriched for that particular term.

```{r go-plot-2, fig.height=7}
dotplot(enrich_go, showCategory = 10, font.size = 12)

ggplot2::ggsave(here("results/go_dotplot.pdf"), height = 10)
```


### KEGG

```{r translate-genes, cache=TRUE}
entrez_genes <- translate_genes(genes_symbol)
```


```{r enrich-kegg, cache=TRUE}
enrich_kegg <- enrichKEGG(
  gene = entrez_genes$entrezgene_id,
  organism = "hsa",
  keyType = "ncbi-geneid",
  pAdjustMethod = "BH",
  qvalueCutoff = 0.05,
  pvalueCutoff = 0.01
)

enrich_pathways <- enrich_kegg@result[enrich_kegg@result$p.adjust < 0.01, ]

write_csv(enrich_terms, here("results/metanalysis_kegg_enrichment.csv"))
```

```{r kegg-plot-1}
barplot(enrich_kegg,
        drop = TRUE,
        showCategory = 10,
        title = "KEGG Pathways")

ggplot2::ggsave(here("results/kegg_barplot.pdf"))
```

```{r kegg-plot-2, fig.height=7}
dotplot(enrich_kegg, showCategory = 10, font.size = 12)

ggplot2::ggsave(here("results/kegg_dotplot.pdf"), height = 7)
```

